## 计划概要

### 三个阶段

1. **网络层配置化** - 解决 IP 硬编码问题，添加连接状态反馈
2. **音频处理完善** - 增益平滑（防点击噪声），可选 Trim/MONO/Boost
3. **OSC 集成** - 接收硬件控制器的 OSC 消息

### 10 个待确认问题 (Q1-Q10)

- **网络**: IP配置方式、服务发现、断连处理
- **音频**: 平滑/Trim/MONO/Boost 是否需要
- **OSC**: 端口、地址格式、LED反馈

请审核计划，告诉我：

1. 哪些功能是必须的，哪些可以跳过
2. Q1-Q10 的答案

Claude’s Plan

# MonitorControllerMax v5.0 发布计划

## 当前状态总结

### 已完成 ✅

- GUI 系统 (egui + wgpu)
- 交互状态机 (Solo/Mute/比较模式)
- VST3 参数同步 (Idle has_sound=true 已修复)
- 配置系统 (Speaker_Config.json)
- ZeroMQ 网络框架 (本机可用)

### 待完成 ⚠️

- 网络层配置化
- 音频处理完善
- OSC 硬件集成

---

## 一、网络层实现计划

### 1.1 当前问题

```rust
// Lib.rs:102 - IP 硬编码
Params::PluginRole::Slave => self.network.init_slave("127.0.0.1", 9123),
```

### 1.2 解决方案：添加网络配置参数

**修改 Params.rs** - 添加网络配置参数：

```rust
// 新增参数
#[id = "master_ip"]
pub master_ip: StringParam,  // 默认 "127.0.0.1"

#[id = "network_port"]
pub network_port: IntParam,  // 默认 9123
```

**修改 Lib.rs** - 使用参数值：

```rust
Params::PluginRole::Slave => {
    let ip = self.params.master_ip.value();
    let port = self.params.network_port.value() as u16;
    self.network.init_slave(&ip, port);
}
```

**修改 Editor.rs** - 添加 IP 输入框：

- 在 Role 选择器下方添加 IP 和 Port 输入框
- 仅当 Role = Slave 时显示

### 1.3 连接状态反馈

**修改 Network.rs** - 添加连接状态：

```rust
pub struct NetworkManager {
    pub sender: Option<Sender<NetworkRenderState>>,
    pub latest_state: Arc<AtomicCell<Option<NetworkRenderState>>>,
    pub connection_status: Arc<AtomicCell<ConnectionStatus>>,  // 新增
}

pub enum ConnectionStatus {
    Disconnected,
    Connecting,
    Connected,
    Error(String),
}
```

**心跳检测** - 基于 timestamp 判断：

```rust
// 如果 3 秒内没有收到新状态，标记为断连
if now - last_timestamp > 3000 {
    connection_status.store(ConnectionStatus::Disconnected);
}
```

**UI 显示** - 在 Editor.rs 中显示连接状态指示器

---

## 二、音频处理完善计划

### 2.1 增益平滑 (防止点击噪声)

**修改 Audio.rs** - 添加平滑器：

```rust
struct GainSmoother {
    current: f32,
    target: f32,
    // 10ms 平滑时间 @ 48kHz = 480 samples
    step: f32,
}

impl GainSmoother {
    fn process(&mut self) -> f32 {
        if (self.current - self.target).abs() > 0.0001 {
            self.current += (self.target - self.current) * self.step;
        } else {
            self.current = self.target;
        }
        self.current
    }
}
```

**应用位置** - `Audio.rs:115`：

```rust
// 原来：*sample *= target_gain;
// 改为：
let smoothed_gain = smoother.process(target_gain);
*sample *= smoothed_gain;
```

### 2.2 Trim 微调 (可选)

**如需实现**：

- Params.rs: 每通道添加 `trim: FloatParam` (-12dB ~ +12dB)
- Channel_Logic.rs: `channel_gains[i] *= db_to_gain(trim)`

### 2.3 MONO 求和 (可选)

**如需实现**：

- Params.rs: 添加 `mono: BoolParam`
- Audio.rs: 当 mono=true 时，将所有通道混合为单声道输出

### 2.4 Low/High Boost (可选)

**如需实现**：

- 需要 DSP 滤波器库 (如 biquad)
- 实现 bass boost (+6dB @ 100Hz) 和 treble boost (+6dB @ 10kHz)

---

## 三、OSC 硬件集成计划

### 3.1 架构设计

```
硬件控制器 (Loupedeck/StreamDeck)
    ↓ OSC 消息 (UDP)
MonitorControllerMax OSC Server
    ↓ 调用
InteractionManager (Solo/Mute 操作)
    ↓ 状态变化
OSC 反馈 → 硬件 LED
```

### 3.2 创建 Osc.rs

**依赖**：添加 `rosc` crate 到 Cargo.toml

 

**OSC Server**：

```rust
pub struct OscManager {
    socket: UdpSocket,
    port: u16,  // 默认 3333
}

impl OscManager {
    pub fn start(&self) {
        // 监听 UDP 端口
        // 解析 OSC 消息
        // 调用 InteractionManager
    }
}
```

### 3.3 OSC 地址映射 (待确认)

|OSC 地址|功能|参数|
|---|---|---|
|`/mcm/solo/{ch}`|Solo 通道|ch: 0-31|
|`/mcm/mute/{ch}`|Mute 通道|ch: 0-31|
|`/mcm/cut`|全局 Cut|-|
|`/mcm/dim`|全局 Dim|-|
|`/mcm/master`|Master Gain|0.0-1.0|

### 3.4 LED 反馈 (待确认)

- 需要向硬件发送当前状态
- OSC 地址格式待定

---

## 四、实施顺序

### 阶段 1：网络层配置化

1. [ ]  Params.rs 添加 master_ip, network_port
2. [ ]  Lib.rs 使用参数值初始化网络
3. [ ]  Editor.rs 添加 IP/Port 输入框
4. [ ]  Network.rs 添加连接状态反馈
5. [ ]  Editor.rs 显示连接状态

### 阶段 2：音频处理完善

6. [ ]  Audio.rs 实现增益平滑
7. [ ]  (可选) 实现 Trim
8. [ ]  (可选) 实现 MONO
9. [ ]  (可选) 实现 Boost

### 阶段 3：OSC 集成

10. [ ]  创建 Osc.rs 基础框架
11. [ ]  实现 OSC 消息解析
12. [ ]  与 InteractionManager 集成
13. [ ]  实现 LED 反馈

---

## 五、待确认问题

### 网络层

- **Q1**: Master IP 配置方式？UI输入 / 配置文件 / 两者都要？
- **Q2**: 是否需要自动服务发现？
- **Q3**: 断连后 Slave 行为？静音 / 保持最后状态 / 提示用户？

### 音频处理

- **Q4**: 增益平滑是否必需？
- **Q5**: Trim 功能是否需要？
- **Q6**: MONO 功能是否需要？
- **Q7**: Boost 功能是否需要？

### OSC

- **Q8**: OSC 端口号？默认 3333？
- **Q9**: OSC 地址格式？上面的映射是否正确？
- **Q10**: 需要发送哪些 LED 反馈？

---

## 六、文件修改清单

|文件|修改内容|阶段|
|---|---|---|
|Params.rs|添加 master_ip, network_port, (trim, mono)|1, 2|
|Lib.rs|使用参数初始化网络|1|
|Network.rs|添加 ConnectionStatus, 心跳检测|1|
|Editor.rs|IP输入框, 连接状态显示|1|
|Audio.rs|增益平滑器|2|
|Channel_Logic.rs|(可选) Trim 应用|2|
|Osc.rs|新建, OSC 服务端|3|
|Cargo.toml|添加 rosc 依赖|3|