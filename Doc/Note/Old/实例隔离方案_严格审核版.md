# MonitorControllerMax é›¶å…±äº«å®ä¾‹éš”ç¦»æ–¹æ¡ˆ

## æ ¸å¿ƒåŸåˆ™

**æ¯ä¸ª VST å®ä¾‹å¿…é¡»å®Œå…¨ç‹¬ç«‹ï¼Œæ²¡æœ‰ä»»ä½•å…¨å±€å…±äº«çŠ¶æ€ã€‚ä¸€ä¸ªå®ä¾‹å´©æºƒç»ä¸èƒ½å½±å“å¦ä¸€ä¸ªå®ä¾‹ã€‚**

---

## é—®é¢˜ä¸€ï¼šæ—¶åºé—®é¢˜ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼‰

### é—®é¢˜æè¿°

DAW åŠ è½½æ’ä»¶æ—¶çš„è°ƒç”¨é¡ºåºï¼š
1. `default()` - åˆ›å»ºæ’ä»¶å®ä¾‹
2. `initialize()` - æ­¤æ—¶ DAW **å°šæœªæ¢å¤å‚æ•°**ï¼Œrole æ˜¯é»˜è®¤å€¼ `Standalone`
3. DAW æ¢å¤ä¿å­˜çš„å‚æ•°ï¼ˆrole å˜ä¸ºå®é™…å€¼ï¼Œå¦‚ `Slave`ï¼‰
4. `reset()` - å‡†å¤‡å¼€å§‹å¤„ç†éŸ³é¢‘
5. `process()` - å¼€å§‹éŸ³é¢‘å¤„ç†

**é—®é¢˜**ï¼šåœ¨ `initialize()` ä¸­åˆå§‹åŒ– OSC/Network æ—¶ï¼Œrole è¿˜æ˜¯é»˜è®¤çš„ `Standalone`ï¼Œå¯¼è‡´ï¼š
- æœ¬åº”æ˜¯ Slave çš„å®ä¾‹é”™è¯¯åœ°åˆå§‹åŒ–äº† OSC
- æœ¬åº”æ˜¯ Master çš„å®ä¾‹å¯èƒ½åˆå§‹åŒ–äº†é”™è¯¯çš„ç½‘ç»œæ¨¡å¼

### è§£å†³æ–¹æ¡ˆï¼šå»¶è¿Ÿåˆå§‹åŒ–

å°† OSC/Network åˆå§‹åŒ–ä» `initialize()` ç§»åˆ° `reset()` æˆ– `process()`ï¼Œæ­¤æ—¶å‚æ•°å·²æ­£ç¡®æ¢å¤ã€‚

### å®ç°ç»†èŠ‚

#### 1. æ·»åŠ å»¶è¿Ÿåˆå§‹åŒ–æ ‡å¿—

```rust
pub struct MonitorControllerMax {
    // ... ç°æœ‰å­—æ®µ ...

    /// æ˜¯å¦éœ€è¦å»¶è¿Ÿåˆå§‹åŒ–
    needs_deferred_init: bool,
    /// å»¶è¿Ÿåˆå§‹åŒ–æ˜¯å¦å·²å®Œæˆ
    deferred_init_done: bool,
}
```

#### 2. ä¿®æ”¹ initialize() - åªè®°å½•é…ç½®ï¼Œä¸åˆå§‹åŒ–

```rust
fn initialize(
    &mut self,
    _audio_io_layout: &AudioIOLayout,
    _buffer_config: &BufferConfig,
    _context: &mut impl InitContext<Self>,
) -> bool {
    // åªè®°å½•è¾“å‡ºé€šé“æ•°ï¼Œä¸åˆå§‹åŒ– OSC/Network
    self.output_channels = _audio_io_layout.main_output_channels
        .map(|c| c.get() as usize)
        .unwrap_or(2);

    // æ ‡è®°éœ€è¦å»¶è¿Ÿåˆå§‹åŒ–
    self.needs_deferred_init = true;
    self.deferred_init_done = false;

    // æ—¥å¿—è®°å½•
    self.logger.log(LogLevel::Info, &format!(
        "[Initialize] output_channels={}, deferred_init=pending",
        self.output_channels
    ));

    true  // åˆå§‹åŒ–æˆåŠŸï¼Œä½† OSC/Network å»¶è¿Ÿ
}
```

#### 3. åœ¨ reset() ä¸­æ‰§è¡Œå»¶è¿Ÿåˆå§‹åŒ–

```rust
fn reset(&mut self) {
    // è®¾ç½®æ—¥å¿—ä¸Šä¸‹æ–‡
    // ...

    // æ‰§è¡Œå»¶è¿Ÿåˆå§‹åŒ–ï¼ˆæ­¤æ—¶ role å·²æ­£ç¡®æ¢å¤ï¼‰
    if self.needs_deferred_init && !self.deferred_init_done {
        self.perform_deferred_init();
    }

    // å¹¿æ’­å½“å‰çŠ¶æ€ï¼ˆå¦‚æœ OSC å·²åˆå§‹åŒ–ï¼‰
    let role = self.params.role.value();
    if role != PluginRole::Slave && self.deferred_init_done {
        self.osc.broadcast_state(...);
    }
}
```

#### 4. åœ¨ process() ä¸­æ·»åŠ å®‰å…¨ç½‘

```rust
fn process(
    &mut self,
    buffer: &mut Buffer,
    _aux: &mut AuxiliaryBuffers,
    _context: &mut impl ProcessContext<Self>,
) -> ProcessStatus {
    // å®‰å…¨ç½‘ï¼šç¡®ä¿å»¶è¿Ÿåˆå§‹åŒ–å·²å®Œæˆ
    if self.needs_deferred_init && !self.deferred_init_done {
        self.perform_deferred_init();
    }

    // ... æ­£å¸¸éŸ³é¢‘å¤„ç† ...
}
```

#### 5. perform_deferred_init() å®ç°

```rust
impl MonitorControllerMax {
    fn perform_deferred_init(&mut self) {
        let role = self.params.role.value();

        self.logger.log(LogLevel::Info, &format!(
            "[DeferredInit] Role={:?}, output_channels={}",
            role, self.output_channels
        ));

        // æ ¹æ® role åˆå§‹åŒ–ç½‘ç»œ
        match role {
            PluginRole::Master => {
                self.network.init_master(9123);
            }
            PluginRole::Slave => {
                self.network.init_slave("127.0.0.1", 9123);
            }
            PluginRole::Standalone => {
                // Standalone ä¸éœ€è¦ç½‘ç»œ
            }
        }

        // æ ¹æ® role åˆå§‹åŒ– OSCï¼ˆSlave ä¸åˆå§‹åŒ–ï¼‰
        if role != PluginRole::Slave {
            self.osc.init(
                self.output_channels,
                self.params.master_gain.value(),
                self.params.dim.value(),
                self.params.cut.value(),
                role,
                self.interaction.clone(),
                &self.instance_id,
                &self.app_config,
            );
        }

        self.last_role = Some(role);
        self.deferred_init_done = true;
        self.needs_deferred_init = false;

        self.logger.log(LogLevel::Info, "[DeferredInit] Complete");
    }
}
```

#### 6. è¿è¡Œæ—¶ Role åˆ‡æ¢æ£€æµ‹ï¼ˆä¿æŒç°æœ‰é€»è¾‘ï¼‰

```rust
// åœ¨ process() ä¸­
let current_role = self.params.role.value();
if let Some(last) = self.last_role {
    if current_role != last {
        // Role å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°åˆå§‹åŒ–
        self.logger.log(LogLevel::Info, &format!(
            "[RoleChange] {:?} -> {:?}", last, current_role
        ));

        // å…³é—­æ—§çš„
        self.network.shutdown();
        self.osc.shutdown();

        // é‡æ–°åˆå§‹åŒ–
        self.perform_deferred_init();
    }
}
self.last_role = Some(current_role);
```

---

## é—®é¢˜äºŒï¼šå…¨å±€å…±äº«çŠ¶æ€ï¼ˆå®ä¾‹éš”ç¦»ï¼‰

### ğŸ”´ ä¸¥æ ¼å®¡æ ¸ç»“æœï¼šæ‰€æœ‰éœ€è¦æ¸…é™¤çš„å…¨å±€çŠ¶æ€ï¼ˆå…± 18 ä¸ªå˜é‡ + 63 å¤„æ—¥å¿—è°ƒç”¨ï¼‰

---

### 1. Osc.rs - 8 ä¸ªå…¨å±€å˜é‡ + 63 å¤„æ—¥å¿—è°ƒç”¨ï¼ˆæœ€ä¸¥é‡ï¼‰

#### å…¨å±€å˜é‡

| è¡Œå· | å˜é‡å | ç±»å‹ | æ”¹ä¸º |
|------|--------|------|------|
| L26 | `CURRENT_CHANNEL_COUNT` | `pub static AtomicUsize` | `OscManager.channel_count` |
| L30 | `CURRENT_CHANNEL_NAMES` | `RwLock<Vec<String>>` | `OscManager.channel_names` |
| L33 | `PREV_CHANNEL_NAMES` | `RwLock<Vec<String>>` | `OscManager.prev_channel_names` |
| L37 | `PENDING_SOLO` | `static AtomicBool` | `OscReceiver.pending_solo` |
| L38 | `PENDING_MUTE` | `static AtomicBool` | `OscReceiver.pending_mute` |
| L41 | `CURRENT_CUT` | `static AtomicBool` | `OscManager.current_cut` |
| L181 | `OSC_SENDER` | `lazy_static OscSender` | `OscManager.sender` |
| L292 | `OSC_RECEIVER` | `lazy_static OscReceiver` | `OscManager.receiver` |

#### ğŸ”´ æ—¥å¿—è°ƒç”¨ï¼ˆå¿…é¡»å…¨éƒ¨æ›¿æ¢ä¸º mcm_* å®ï¼‰

**æ–‡ä»¶ä½¿ç”¨ `use log::{info, warn, error};`ï¼ˆLine 11ï¼‰å¯¼è‡´æ—¥å¿—äº¤ç»‡ï¼**

| ç±»å‹ | æ•°é‡ | éœ€è¦æ›¿æ¢ä¸º |
|------|------|-----------|
| `info!(...)` | 47 å¤„ | `mcm_info!(...)` |
| `warn!(...)` | 12 å¤„ | `mcm_warn!(...)` |
| `error!(...)` | 4 å¤„ | `mcm_error!(...)` |
| **æ€»è®¡** | **63 å¤„** | |

å…³é”®è¡Œå·ï¼š336, 372, 379, 395, 416, 423, 436, 461, 477, 483, 508, 514, 524, 530, 537, 555, 561, 572, 613, 664, 690, 724, 737, 748, 754, 767, 778, 784, 802, 809, 813, 818, 826, 831, 836, 842, 848, 852, 868, 874, 884, 890, 899, 905, 917, 922, 927, 938, 946, 954, 962, 982, 986, 993, 1035, 1045, 1049, 1068, 1073

---

### 2. Audio.rs - 1 ä¸ªå…¨å±€å˜é‡ï¼ˆéœ€ç‰¹æ®Šå¤„ç†ï¼‰

| è¡Œå· | å˜é‡å | ç±»å‹ | è¯´æ˜ |
|------|--------|------|------|
| L15 | `CURRENT_GAINS` | `static [AtomicU32; MAX_CHANNELS]` | ç”¨äºå¹³æ»‘å¢ç›Šï¼Œæ¯ä¸ªå®ä¾‹éœ€è¦ç‹¬ç«‹çš„å¢ç›ŠçŠ¶æ€ |

**å¤„ç†æ–¹æ¡ˆ**ï¼šå°† `CURRENT_GAINS` ç§»å…¥ `MonitorControllerMax` å®ä¾‹å­—æ®µ

---

### 3. Editor.rs - 2 ä¸ªå…¨å±€å˜é‡ï¼ˆéœ€ç§»é™¤ï¼‰

| è¡Œå· | å˜é‡å | ç±»å‹ | æ”¹ä¸º |
|------|--------|------|------|
| L27 | `PREV_LAYOUT` | `static AtomicI32` | Editor é—­åŒ…å†…çš„å±€éƒ¨å˜é‡ |
| L28 | `PREV_SUB_LAYOUT` | `static AtomicI32` | Editor é—­åŒ…å†…çš„å±€éƒ¨å˜é‡ |

---

### 4. Interaction.rs - 1 ä¸ªå…¨å±€å˜é‡ï¼ˆéœ€ç§»é™¤ï¼‰

| è¡Œå· | å˜é‡å | ç±»å‹ | æ”¹ä¸º |
|------|--------|------|------|
| L936-938 | `INTERACTION` | `lazy_static InteractionManager` | åˆ é™¤ï¼ˆå·²æ ‡è®° deprecatedï¼‰ |
| L941-944 | `get_interaction_manager()` | å‡½æ•° | åˆ é™¤ |

---

### 5. config_file.rs - 1 ä¸ªå…¨å±€å˜é‡ï¼ˆéœ€ç§»é™¤ï¼‰

| è¡Œå· | å˜é‡å | ç±»å‹ | æ”¹ä¸º |
|------|--------|------|------|
| L119-120 | `APP_CONFIG` | `lazy_static ConfigStore` | åˆ é™¤ï¼Œä½¿ç”¨ `load_app_config()` å‡½æ•° |

---

### 6. logger.rs - 1 ä¸ªå…¨å±€å˜é‡ï¼ˆä¿ç•™ä½†é‡æ„ï¼‰

| è¡Œå· | å˜é‡å | ç±»å‹ | è¯´æ˜ |
|------|--------|------|------|
| L14 | `LOG_FILE` | `OnceLock<Mutex<File>>` | å½“å‰è®¾è®¡æ¯å®ä¾‹æœ‰ç‹¬ç«‹æ–‡ä»¶ï¼Œä¿ç•™ä½†ç¡®ä¿éš”ç¦» |

---

### 7. Network.rs - âœ… å·²æ¸…ç†å®Œæˆ

- æ— å…¨å±€å˜é‡
- æ‰€æœ‰æ—¥å¿—è°ƒç”¨å·²ä½¿ç”¨ `mcm_info!` / `mcm_error!`

---

### 8. å…¶ä»–æ–‡ä»¶ - âœ… æ— é—®é¢˜

- `Lib.rs` - ä½¿ç”¨ `mcm_info!`ï¼Œæ— å…¨å±€å˜é‡
- `Channel_Logic.rs` - çº¯è®¡ç®—é€»è¾‘ï¼Œæ— å…¨å±€çŠ¶æ€
- `Params.rs` - å‚æ•°å®šä¹‰ï¼Œæ— å…¨å±€çŠ¶æ€
- `Network_Protocol.rs` - åè®®å®šä¹‰ï¼Œæ— å…¨å±€çŠ¶æ€

---

## ğŸš€ ä¿®è®¢åçš„å®æ–½é¡ºåº

### ç¬¬ä¸€é˜¶æ®µï¼šä¿®å¤æ—¥å¿—äº¤ç»‡é—®é¢˜ï¼ˆç´§æ€¥ï¼‰

1. **Osc.rs æ—¥å¿—ä¿®å¤** - å°† 63 å¤„ `log::{info,warn,error}` æ›¿æ¢ä¸º `mcm_{info,warn,error}`
   - åˆ é™¤ `use log::{info, warn, error};`ï¼ˆLine 11ï¼‰
   - æ·»åŠ  `use crate::{mcm_info, mcm_warn, mcm_error};`
   - é€ä¸€æ›¿æ¢æ‰€æœ‰ 47 å¤„ `info!` â†’ `mcm_info!`
   - é€ä¸€æ›¿æ¢æ‰€æœ‰ 12 å¤„ `warn!` â†’ `mcm_warn!`
   - é€ä¸€æ›¿æ¢æ‰€æœ‰ 4 å¤„ `error!` â†’ `mcm_error!`

### ç¬¬äºŒé˜¶æ®µï¼šæ¸…é™¤å…¨å±€çŠ¶æ€

2. **config_file.rs** - åˆ é™¤ `APP_CONFIG` å…¨å±€ï¼ˆå¦‚æœä»å­˜åœ¨ï¼‰
3. **Interaction.rs** - åˆ é™¤ `INTERACTION` å…¨å±€å’Œ `get_interaction_manager()` å‡½æ•°
4. **Editor.rs** - åˆ é™¤ `PREV_LAYOUT` å’Œ `PREV_SUB_LAYOUT` å…¨å±€ï¼Œæ”¹ä¸ºé—­åŒ…å±€éƒ¨å˜é‡
5. **Audio.rs** - å°† `CURRENT_GAINS` ç§»å…¥å®ä¾‹å­—æ®µ

### ç¬¬ä¸‰é˜¶æ®µï¼šé‡æ„ Osc.rsï¼ˆæ ¸å¿ƒï¼‰

6. **Osc.rs å…¨å±€å˜é‡æ¸…é™¤** - åˆ é™¤æ‰€æœ‰ 8 ä¸ªå…¨å±€å˜é‡
   - åˆ é™¤ `CURRENT_CHANNEL_COUNT`
   - åˆ é™¤ `CURRENT_CHANNEL_NAMES`
   - åˆ é™¤ `PREV_CHANNEL_NAMES`
   - åˆ é™¤ `PENDING_SOLO`
   - åˆ é™¤ `PENDING_MUTE`
   - åˆ é™¤ `CURRENT_CUT`
   - åˆ é™¤ `OSC_SENDER`
   - åˆ é™¤ `OSC_RECEIVER`
   - å…¨éƒ¨ç§»å…¥ `OscManager` å®ä¾‹å­—æ®µ

### ç¬¬å››é˜¶æ®µï¼šæ›´æ–°ä¾èµ–

7. **Lib.rs** - ç¡®ä¿æ‰€æœ‰ç»„ä»¶éƒ½æ˜¯å®ä¾‹çº§
8. **Editor.rs** - æ›´æ–°æ‰€æœ‰ OSC å¼•ç”¨ä¸ºå®ä¾‹çº§å‚æ•°

### ç¬¬äº”é˜¶æ®µï¼šéªŒè¯

9. **Build** - ç¼–è¯‘é€šè¿‡
10. **æµ‹è¯•** - éªŒè¯å¤šå®ä¾‹å®Œå…¨éš”ç¦»ï¼Œæ—¥å¿—ä¸å†äº¤ç»‡

---

## éªŒè¯æµ‹è¯•

1. **éš”ç¦»æµ‹è¯•**ï¼šåŒæ—¶åŠ è½½ 2 ä¸ªå®ä¾‹ï¼Œå„è‡ªç‹¬ç«‹æ“ä½œ
2. **å´©æºƒæµ‹è¯•**ï¼šå¼ºåˆ¶ä¸€ä¸ªå®ä¾‹å´©æºƒï¼ŒéªŒè¯å¦ä¸€ä¸ªä¸å—å½±å“
3. **ç«¯å£å†²çªæµ‹è¯•**ï¼šä¸¤ä¸ªé Slave å®ä¾‹ï¼ŒéªŒè¯é®ç½©æ˜¾ç¤º
4. **é…ç½®æµ‹è¯•**ï¼šæ¯ä¸ªå®ä¾‹ä½¿ç”¨ç‹¬ç«‹çš„ OSC ç«¯å£é…ç½®
5. **æ—¥å¿—æµ‹è¯•**ï¼šæ¯ä¸ªå®ä¾‹å†™å…¥ç‹¬ç«‹çš„æ—¥å¿—æ–‡ä»¶
