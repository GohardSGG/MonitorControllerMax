## 当前通信机制 - 使用流程视角

### 一、三种运行模式

插件有一个 `Role` 参数，决定运行模式：

|模式|用途|网络|OSC 硬件|
|---|---|---|---|
|**Standalone**|单机使用|❌ 无|✅ 有|
|**Master**|主控端|✅ 广播状态|✅ 有|
|**Slave**|从属端|✅ 接收状态|❌ 无|

---

### 二、Standalone 模式（最简单）

**场景**：你只有一台电脑、一个 DAW 实例

```
┌─────────────────────────────────────────────────────────┐
│  DAW (单实例)                                            │
│  ┌───────────────────────┐                              │
│  │ MonitorControllerMax  │◄──── OSC ────► Loupedeck    │
│  │ (Standalone 模式)      │     7444/7445              │
│  └───────────────────────┘                              │
└─────────────────────────────────────────────────────────┘
```

**使用流程**：

1. 在 DAW 中加载插件
2. 设置 Role = Standalone
3. 插件直接计算音频，同时通过 OSC 与 Loupedeck 通信

---

### 三、Master-Slave 模式

**场景**：多个 DAW 实例需要同步监听控制

```
┌─────────────────────────────────────────────────────────┐
│  DAW 实例 A (例如：主混音工程)                            │
│  ┌───────────────────────┐                              │
│  │ MonitorControllerMax  │◄──── OSC ────► Loupedeck    │
│  │ (Master 模式)          │     7444/7445              │
│  └─────────┬─────────────┘                              │
│            │ ZMQ PUB (端口 9123)                         │
│            │ 广播 RenderState                            │
└────────────┼────────────────────────────────────────────┘
             │
             ▼ (本机 127.0.0.1)
┌────────────┴────────────────────────────────────────────┐
│  DAW 实例 B (例如：参考工程)                              │
│  ┌───────────────────────┐                              │
│  │ MonitorControllerMax  │  ← 无 OSC（不控制硬件）        │
│  │ (Slave 模式)           │                              │
│  └───────────────────────┘                              │
│  音频跟随 Master 的增益/静音状态                          │
└─────────────────────────────────────────────────────────┘
```

**数据流**：

1. **Master** 计算 `RenderState`（增益、静音掩码）
2. **Master** 通过 ZMQ 广播状态到端口 9123
3. **Slave** 订阅 127.0.0.1:9123，接收状态
4. **Slave** 直接使用收到的状态处理音频（不自己计算）

---

### 四、当前限制

|限制|说明|
|---|---|
|**仅本机**|Slave 硬编码连接 `127.0.0.1:9123`，不支持跨机|
|**无配置界面**|端口、IP 都是代码写死的|
|**无连接状态**|UI 不显示 Slave 是否已连接 Master|
|**断连行为**|Slave 断连后保持最后状态或静音（安全模式）|

---

### 五、验证步骤建议

**1. 先验证 Standalone 模式**（最简单）：

- 打开一个 DAW
- 加载插件，设置 Role = Standalone
- 播放音频，测试 Cut/Dim/Solo/Mute

**2. 再验证 Master-Slave**：

- 打开 DAW 实例 A，加载插件，设置 Role = Master
- 打开 DAW 实例 B，加载插件，设置 Role = Slave
- 在 A 中操作，观察 B 是否跟随

需要我帮你确认具体的端口配置或其他细节吗？