# 4. 统一开发流程

## 4.1 环境准备

1. **Rust Toolchain**: 确保安装最新 Stable 版本 (`rustup update`).
   - 需要添加 target: `rustup target add wasm32-unknown-unknown` (如果开发 Web 前端).
2. **依赖工具**:
   - `LLVM` (Windows 下编译某些 crate 可能需要).
   - `CMake`.

## 4.2 构建与运行

本项目使用 `xtask` 自动化构建流程。

### 4.2.1 常用命令

| 动作 | 命令 | 说明 |
| :--- | :--- | :--- |
| **检查代码** | `cargo check --workspace` | 快速语法检查 |
| **全量编译** | `cargo build --workspace` | 编译所有 Crate |
| **打包插件** | `cargo xtask bundle monitor_controller_max` | 编译并生成 .vst3 bundle |
| **发布打包** | `cargo xtask bundle monitor_controller_max --release` | 优化版本，体积更小，性能更高 |
| **生产部署** | `cargo xtask bundle monitor_controller_max --production` | **需管理员权限**。部署到系统 VST3 目录。 |
| **清理** | `cargo clean` | 清理 target 目录 |

### 4.2.2 产物位置
- **Debug**: `Build/Debug/MonitorControllerMax.vst3`
- **Release**: `Build/Release/MonitorControllerMax.vst3`
- **System (Win)**: `C:\Program Files\Common Files\VST3\MonitorControllerMax.vst3`

## 4.3 调试指南

### 4.3.1 日志调试
开发版插件会自动在 UI 上显示 "LOG" 面板。也可以查看日志文件：
- `C:\Plugins\MCM_Logs\` (默认)
- `%TEMP%\MonitorControllerMax_Logs\` (Fallback)

### 4.3.2 调试器调试 (VS Code)
使用 `CodeLLDB` 扩展。
在 `.vscode/launch.json` 中配置 Attach 到 DAW 进程 (如 Reaper)。

1. 启动 DAW。
2. VS Code F5 "Attach to Reaper"。
3. 加载插件，断点即可命中。

## 4.4 常见问题排查

- **编译报错 "file not found"**: 检查 `xtask` 脚本是否正确找到了 `nih-plug` 依赖。
- **插件无法加载**: 检查是否安装了 VC++ Redistributable (Windows)。
- **Web 页面打不开**: 检查防火墙是否允许端口 8080，或日志中是否有端口占用错误。
