# 5. 功能模块设计

## 5.1 Protocol 层 (mcm_protocol)

定义了系统的"通用语言"。

- **`config.rs`**: `AppConfig` 结构体，序列化为 JSON，存储 OSC/Network 端口配置。
- **`web_structs.rs`**: 
    - `WebSharedState`: 使用 Atomic 字段实现的线程安全状态（端口、运行标志）。
    - `WebCommand/WebState`: WebSocket 通信协议。
- **`osc_structs.rs`**: OSC 地址定义和参数映射。

## 5.2 Core 层 (mcm_core)

- **`params.rs`**: 
    - `MonitorParams`: 基于 `nih-plug` 的参数树。
    - 包含 `input_gain`, `output_gain`, `solo_xxx`, `mute_xxx` 等参数。
- **`interaction.rs`**:
    - `InteractionManager`: 业务逻辑核心。管理 `Solo/Mute` 组逻辑、`Primary/Compare` 模式切换。
    - **无锁设计**: 使用 `RwLock` 保护非实时状态，`Atomic` 保护实时标志。
- **`audio_processor.rs`**:
    - 纯音频处理函数。输入 `AudioBuffer` + `RenderSnapshot`，输出处理后的音频。

## 5.3 Reactor 层 (mcm_reactor)

基于 `tokio` 的 Sidecar 模式。

- **`lib.rs/Reactor`**: 
    - 启动一个后台线程运行 Tokio Runtime。
    - 通过 `crossbeam::channel` 接收宿主指令 (`StartWeb`, `SendOsc`...)。
- **`actors/web.rs`**:
    - 基于 `Axum` 的 HTTP/WebSocket 服务。
    - 提供静态文件服务 (前端页面) 和 WebSocket API (实时控制)。
    - **限制**: 目前只能读取状态，参数修改逻辑通过 TODO 队列待接入 Editor。
- **`actors/osc.rs`**:
    - 基于 `rosc` 的 UDP 服务。
    - 维护 `OscSharedState`，实现 Params <-> OSC 消息的双向同步。
- **`actors/network.rs`**:
    - ZeroMQ PUB/SUB 实现，负责跨机状态广播。

## 5.4 Plugin 层 (monitor_controller_max)

- **`lib.rs`**: 插件入口，实现 `ClapPlugin` / `Vst3Plugin` trait。
- **`editor.rs`**: 
    - 基于 `egui` 的 GUI 实现。
    - 负责从 `WebSharedState` 读取状态并显示（如 Web 地址）。
    - 负责处理各种 Dialog (Settings, Layout)。
- **`components/`**: 可复用的 UI 组件 (Fader, Knob, LevelMeter)。
