# 7. 技术风险与解决方案 (更新于 2025.12.09)

## 7.1 风险矩阵

| 风险项 | 状态 | 可能性 | 严重性 | 描述 | 解决方案 |
| :--- | :--- |:---|:---|:---|:---|
| **GUI 框架兼容性** | ✅ 已解决 | 低 | 高 | `egui` + `glow` 兼容性问题。 | 切换至 `wgpu` 后端。 |
| **网络延迟与丢包** | ✅ 已实现 | 低 | 中 | 跨机通信导致操作滞后。 | ZMQ PUB/SUB + TCP，局域网延迟 <1ms。状态保持机制解决丢包风险。 |
| **Master 故障影响** | ✅ 已实现 | 低 | 极高 | Master 崩溃导致系统全开爆音。 | Slave 具备状态保持特性，Master 挂掉时维持原状。 |
| **OSC 端口冲突** | ⚠️ 待优化 | 中 | 中 | 端口占用。 | 当前硬编码端口 9124，计划增加配置选项。 |
| **网络地址配置** | ⚠️ 待优化 | 中 | 低 | Slave 连接地址硬编码为 `127.0.0.1`。 | 如需跨机部署，需添加 IP 配置功能。 |
| **增益切换噪声** | ⏳ 待验证 | 中 | 中 | Solo/Mute 切换时可能产生点击声。 | 如验证存在问题，添加增益平滑 (ramping)。 |

## 7.2 已验证的解决方案

### 7.2.1 根除"死亡指针" (The Weak Ref Pattern)
**问题**: C++ 版本使用裸指针管理插件列表，导致 Use-After-Free 崩溃。

**解决方案**: Rust 的所有权机制 + Registry 模式
- 使用 `Arc<RwLock<T>>` 管理共享状态
- 编译期强制生命周期检查
- 运行时零成本安全保障

### 7.2.2 分布式状态同步 (The ZMQ Snapshot Pattern)
**旧方案**: 进程内指针/共享内存，不支持跨机。

**新方案 (v4.0)**:
```
Master: ChannelLogic → RenderState → Bincode序列化 → ZMQ PUB (端口9123)
Slave:  ZMQ SUB → 反序列化 → AtomicCell缓存 → DSP无锁读取
```

**优势**:
- 天然解耦，支持跨机
- TCP 自动重连
- 状态保持（Slave 在断连时维持最后状态）

### 7.2.3 复杂 Solo 逻辑的解耦 (The Logic Core)
**问题**: v4.0 规范的交互逻辑极其复杂（混合 Solo、SUB 豁免、A/B 对比）。

**解决方案**: `InteractionManager` 状态机
- PrimaryMode + CompareMode 双层模式
- ChannelSet 基于 HashSet<String> 存储
- 自动反转逻辑（copy_set）
- 与 UI、DSP 完全分离，可单独测试

## 7.3 当前待验证项

### 7.3.1 音频处理正确性
**验证目标**: 确认以下功能真正作用于音频输出

| 功能 | 预期行为 | 验证方法 |
|------|---------|---------|
| Cut | 完全静音 | 播放音频 → 点击 Cut → 输出应为静音 |
| Dim | 衰减 -20dB | 播放音频 → 点击 Dim → 音量应明显降低 |
| Volume | 连续音量控制 | 转动旋钮 → 音量应平滑变化 |
| Solo 通道 | 仅选中通道有声 | Solo L → 只有左声道输出 |
| Mute 通道 | 选中通道静音 | Mute L → 左声道静音 |

**关键代码路径**:
```
用户操作 → InteractionManager → ChannelLogic::compute() → RenderState → Audio::process_audio()
```

### 7.3.2 Master-Slave 通信稳定性
**验证目标**: 确认状态同步正确工作

| 场景 | 配置 | 预期 |
|------|-----|------|
| 本机测试 | 同一 DAW 内 Master + Slave | Slave 跟随 Master 状态 |
| 跨实例测试 | 两个 DAW 实例 | 状态实时同步 (<5ms) |
| 断连测试 | 关闭 Master | Slave 保持最后状态，无爆音 |

**关键代码路径**:
```
Master: ChannelLogic → RenderState → NetworkRenderState → ZMQ Pub
Slave:  ZMQ Sub → AtomicCell → Audio::process_audio()
```

## 7.4 已知限制

1. **网络地址硬编码**: Slave 连接 `tcp://127.0.0.1:9123`，不支持配置远程 IP
2. **无连接状态显示**: UI 不显示 Master-Slave 连接状态
3. **单一 Master**: 不支持多 Master 场景

这些限制在当前使用场景下可接受，如有需要可在后续版本中改进。
