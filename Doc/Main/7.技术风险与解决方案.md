# 7. 技术风险与解决方案

## 7.1 内存安全与生命周期

### 风险：Use-After-Free
在音频线程运行过程中，UI 线程可能修改配置或销毁对象。
- **解决方案**: `Arc` (原子引用计数) + `Core` 纯函数设计。音频线程持有必要状态的 `Arc` 克隆，即使主线程销毁了 Editor，音频处理所依赖的数据依然有效，直到音频线程释放。

### 风险：循环引用 (Reference Cycle)
Plugin -> Reactor -> Plugin 曾导致内存泄漏和编译死锁。
- **解决方案**: 
    1. **架构层面**: 引入 `mcm_protocol` 作为公共依赖，打破类型依赖环。
    2. **运行时层面**: 使用 `Weak` 引用或 Channel 传递消息，避免强引用闭环。

## 7.2 线程安全 (Concurrency)

### 风险：UI 卡顿与音频爆音
UI 线程阻塞会导致界面掉帧；音频线程阻塞会导致爆音 (Xrun)。
- **解决方案**: 
    - **Reactor 模式**: 所有网络 I/O (Web, OSC, ZMQ) 移至独立的 Tokio 线程。
    - **无锁队列**: 使用 `crossbeam::channel` 进行跨线程指令传递。
    - **原子状态**: 使用 `AtomicBool`, `AtomicF32` 等类型在线程间同步简单状态，无需 Mutex。

## 7.3 构建与依赖

### 风险：Dependency Hell
不同 crate 依赖不同版本的库 (如 `syn`, `windows`) 导致冲突。
- **解决方案**: 在 Workspace 根 `Cargo.toml` 中统一声明 `[workspace.dependencies]`，强制所有子 crate 使用相同版本。

### 风险：SDK 兼容性
`nih-plug` 更新可能破坏 API。
- **解决方案**: 将 `nih-plug` 源码 Vendor 到 `Library/` 目录，并锁定具体 commit。项目永远基于本地测试通过的 SDK 版本构建。
