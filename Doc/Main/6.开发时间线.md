# 6. 开发路线图 (Roadmap) - 更新于 2025.12.13

本路线图以**里程碑**为导向。

---

## ✅ 阶段一：GUI 基础设施构建与样式定稿 (已完成)

**已交付成果**:
- 1. **基础设施**：`wgpu` 后端，DPI 缩放 (`set_scale_factor_override`)。
- 2. **视觉风格**：Brutalist 组件库，响应式布局。
- 3. **复杂布局**：Header, Sidebar, Matrix, Log Panel。
- 4. **构建流程**：`xtask` 修复。

---

## ✅ 阶段二：核心逻辑与网络层实现 (已完成)

**目标**: 实现 v4.0 规范的核心逻辑，并打通基于 ZMQ 的分布式通信。

**已交付成果**:
- [x] **Params 定义**: `MonitorParams` 完整实现 (Cut/Dim/Volume/通道状态)
- [x] **Logic 实现**: `ChannelLogic::compute()` 纯函数计算 `RenderState`
- [x] **网络层开发**: ZeroMQ PUB/SUB (端口 9123) + Bincode 序列化
- [x] **Slave 状态机**: `AtomicCell` 无锁缓存读取
- [x] **数据结构**: `RenderState` + `NetworkRenderState` (magic: 0x4D43)

---

## ✅ 阶段三：UI 功能绑定与交互实现 (已完成)

**目标**: 将 GUI 按钮与逻辑核心对接。

**已交付成果**:
- [x] **交互状态机**: `InteractionManager` v4.0 完整实现
  - PrimaryMode (None/Solo/Mute) + CompareMode (None/Solo/Mute)
  - 自动反转逻辑 (copy_set)
  - 记忆标记 (solo_has_memory/mute_has_memory)
- [x] **通道集合**: `ChannelSet` 基于 HashSet<String> 存储通道名
- [x] **GUI 绑定**: Solo/Mute/Cut/Dim/Volume 按钮完整联动
- [x] **视觉反馈**:
  - 常亮 (Primary模式) / 闪烁 (Compare模式)
  - Solo=绿色, Mute=红色, Idle=灰色
- [x] **SUB 特殊逻辑**: 豁免权 + User Mute (双击强制静音)

---

## ✅ 阶段四：硬件集成 (已完成)

**目标**: OSC 硬件联动。

**已交付成果**:
- [x] **OSC 通信**: 双向收发 (发送端口 7444 / 接收端口 7445)
- [x] **Loupedeck 集成**: C# 插件 `MonitorOSCPlugin`
- [x] **模式控制**: `/Monitor/Mode/Solo`, `/Monitor/Mode/Mute`
- [x] **通道控制**: `/Monitor/Channel/{name}` (0=Off, 1=Mute, 2=Solo)
- [x] **语义层扩展**: value=10 (有声音), value=11 (增量移除), value=12 (可退出移除)
- [x] **闪烁定时器**: Compare 模式下的视觉同步
- [x] **Cut 双向同步**: GUI ↔ 硬件状态一致

---

## ✅ 阶段五：鲁棒性修复与优化 (已完成 v2.5.0-v2.5.8)

**目标**: 修复 Master-Slave 通信中的边缘问题，提升系统鲁棒性。

**已交付成果**:

### 核心功能
- [x] **UI Role 切换**: 切换 Role 后立即触发网络初始化
- [x] **心跳超时**: Slave 检测 Master 离线 (2秒超时) 并自动重连
- [x] **协议版本检查**: `protocol_version=2` + `magic=0x4D43` 防止不兼容
- [x] **Slave UI 禁用**: Slave 模式下通道点击/按钮被禁用

### 基础设施
- [x] **实例级日志**: 每个 VST 实例独立日志文件 (`InstanceLogger`)
- [x] **UI 日志面板**: 显示最近 50 条 `important()` 级别日志
- [x] **热重载机制**: 无需重启 DAW 即可修改 OSC/Network 端口
- [x] **Production 模式**: `--production` 构建禁用文件日志

### 修复的关键 Bug

| Bug | 根因 | 修复版本 |
|-----|------|---------|
| UI Role 切换不触发网络初始化 | `reset()` 只在 DAW 恢复时调用 | v2.5.8 |
| 心跳超时后线程不退出 | `is_running` 未在超时路径清理 | v2.5.8 |
| Runtime 创建失败 `is_running` 未清理 | 线程提前 return 未清理标志 | v2.5.8 |
| Slave 模式通道可点击 | 无 Slave 模式检查 | v2.5.8 |
| 布局切换后状态异常 | 旧通道名在新布局不存在 | v2.5.8 |
| 协议版本不兼容 | 无版本检查 | v2.5.0 |

---

## ➡️ 阶段六：发布前最终验证 (当前阶段)

**目标**: 完成所有验证，准备发布。

**核心任务**:
- [ ] **完整功能测试**: 按照 4.4.2 检查清单验证所有功能
- [ ] **跨机测试**: 两台电脑间的 Master-Slave 通信
- [ ] **压力测试**: 长时间运行稳定性
- [ ] **用户手册**: 基础操作文档

**验收标准 (v2.5.8 Release)**:
- 所有功能测试通过
- 无已知 P0/P1 Bug
- 文档同步更新
