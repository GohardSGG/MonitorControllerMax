# 3. 项目规范与约定

## 3.1 代码组织规范 (Workspace)

本项目采用 Rust Workspace 模式，所有源码位于 `Source/` 目录下：

- **Crate 命名**: 使用 `snake_case`，前缀 `mcm_` (Monitor Controller Max)。
    - `mcm_core`
    - `mcm_reactor`
    - `mcm_protocol`
    - `mcm_infra`
    - `monitor_controller_max` (Plugin，例外，保持原名以匹配发布文件名)
- **目录结构**:
    - `src/`: 源码
    - `src/lib.rs`: 库入口
    - `src/actors/`: Actor 模式实现 (仅 Reactor)

## 3.2 编码规范

遵循标准 Rust 风格指南 (`rustfmt`)，并补充以下特定规则：

### 3.2.1 引用与依赖
- **禁止循环依赖**: Plugin 不应被 Core/Reactor 反向依赖。共享类型必须下沉到 `mcm_protocol`。
- **本地依赖**: 优先使用 Workspace 内部依赖 (`path = "../Core"`)。
- **第三方库**: `nih-plug` 使用 `Library/` 下的本地修改版，严禁直接引用 crates.io 或 github 远程版本（为了保证补丁的一致性）。

### 3.2.2 线程安全
- **全局变量**: 严禁使用 `static mut`。使用 `Arc<RwLock<T>>` 或 `Atomic` 类型。
- **音频线程**: 
    - ❌ 禁止: `Mutex`, `RwLock.write()`, `Vec::push`, `String::new`, `println!`.
    - ✅ 允许: `Atomic::load/store`, `ArcSwap::load`.

### 3.2.3 日志规范
- 使用 `mcm_infra::logger::InstanceLogger`。
- 格式: `logger.info("module_name", "message")`。
- Module Name 约定:
    - `"core"`: 核心逻辑
    - `"reactor"`: 异步任务
    - `"network"`: ZMQ 通信
    - `"osc"`: OSC 通信
    - `"web"`: Web 服务
    - `"editor"`: GUI 交互

## 3.3 版本管理

- **主版本号**: 跟随 `monitor_controller_max` 的 `Cargo.toml`。
- **Tag 规范**: `v{Major}.{Minor}.{Patch}` (e.g. `v2.6.0`).
- **提交信息**: 遵循 Conventional Commits (e.g. `feat: add web controller`, `fix: osc port conflict`).
